<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cloud Setup Guide â€” Fidra</title>
    <meta name="description" content="Set up a Supabase cloud backend for Fidra to enable multi-user access and real-time sync." />
    <meta name="theme-color" content="#1a1d1b" />
    <link rel="icon" href="assets/logo.svg" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="ambient" aria-hidden="true"></div>
    <header class="nav">
      <div class="logo">
        <a href="index.html" style="display:flex;align-items:center;gap:12px;">
          <img src="assets/logo.svg" alt="Fidra" />
          <span>Fidra</span>
        </a>
      </div>
      <nav class="nav-links">
        <a href="index.html#downloads">Download</a>
        <a href="index.html#features">Features</a>
        <a href="index.html#cloud">Cloud Sync</a>
        <a href="index.html#faq">FAQ</a>
      </nav>
      <a class="nav-cta" href="index.html#downloads">Get Fidra</a>
    </header>

    <main>
      <article class="guide">
        <div class="guide-header">
          <a href="index.html" class="guide-back">&larr; Back to Fidra</a>
          <h1>Cloud Server Setup Guide</h1>
          <p class="guide-subtitle">Set up a Supabase cloud backend for Fidra, enabling multi-user access and cloud-hosted data storage.</p>
        </div>

        <div class="guide-overview">
          <p>Fidra supports two storage backends:</p>
          <ul>
            <li><strong>SQLite</strong> (default) &mdash; Local file storage, single-user</li>
            <li><strong>Cloud (Supabase)</strong> &mdash; PostgreSQL database with cloud storage for attachments, multi-user support</li>
          </ul>
        </div>

        <nav class="guide-toc">
          <h3>Contents</h3>
          <ol>
            <li><a href="#part1">Supabase Project Setup</a></li>
            <li><a href="#part2">Database Schema</a></li>
            <li><a href="#part3">Storage Bucket Setup</a></li>
            <li><a href="#part4">Connecting Fidra to Supabase</a></li>
            <li><a href="#part5">How Sync Works</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#security">Security Considerations</a></li>
          </ol>
        </nav>

        <!-- Part 1 -->
        <section id="part1" class="guide-section">
          <h2>Part 1: Supabase Project Setup</h2>
          <h3>1.1 Create a Supabase Project</h3>
          <ol>
            <li>Go to <a href="https://supabase.com" class="guide-link" rel="noreferrer">supabase.com</a> and sign in</li>
            <li>Click <strong>New Project</strong></li>
            <li>Enter a project name (e.g., "Fidra Finance")</li>
            <li>Set a <strong>database password</strong> &mdash; save this, you'll need it later</li>
            <li>Select a region close to your users</li>
            <li>Click <strong>Create new project</strong></li>
          </ol>
          <p>Wait for the project to be provisioned (usually 1&ndash;2 minutes).</p>
        </section>

        <!-- Part 2 -->
        <section id="part2" class="guide-section">
          <h2>Part 2: Database Schema</h2>
          <h3>2.1 Create the Database Tables</h3>
          <ol>
            <li>In your Supabase dashboard, go to <strong>SQL Editor</strong></li>
            <li>Click <strong>New query</strong></li>
            <li>Paste the following SQL and click <strong>Run</strong>:</li>
          </ol>
          <pre><code>-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Transactions table
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    date DATE NOT NULL,
    description TEXT NOT NULL,
    amount NUMERIC(15, 2) NOT NULL CHECK (amount > 0),
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    status TEXT NOT NULL CHECK (status IN ('--', 'pending', 'approved', 'rejected', 'planned')),
    sheet TEXT NOT NULL,
    category TEXT,
    party TEXT,
    notes TEXT,
    reference TEXT,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    modified_at TIMESTAMPTZ,
    modified_by TEXT
);

CREATE INDEX idx_transactions_date ON transactions(date DESC);
CREATE INDEX idx_transactions_sheet ON transactions(sheet);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_status ON transactions(status);

-- Planned templates table
CREATE TABLE planned_templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    start_date DATE NOT NULL,
    description TEXT NOT NULL,
    amount NUMERIC(15, 2) NOT NULL CHECK (amount > 0),
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    frequency TEXT NOT NULL CHECK (frequency IN ('once', 'weekly', 'biweekly', 'monthly', 'quarterly', 'yearly')),
    target_sheet TEXT NOT NULL,
    category TEXT,
    party TEXT,
    end_date DATE,
    occurrence_count INTEGER,
    skipped_dates JSONB DEFAULT '[]'::jsonb,
    fulfilled_dates JSONB DEFAULT '[]'::jsonb,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_planned_start ON planned_templates(start_date);
CREATE INDEX idx_planned_target ON planned_templates(target_sheet);

-- Sheets table
CREATE TABLE sheets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT UNIQUE NOT NULL,
    is_virtual BOOLEAN DEFAULT FALSE,
    is_planned BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_sheets_name ON sheets(name);

-- Attachments table (metadata only - files in Supabase Storage)
CREATE TABLE attachments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    transaction_id UUID NOT NULL REFERENCES transactions(id) ON DELETE CASCADE,
    filename TEXT NOT NULL,
    stored_name TEXT NOT NULL,
    mime_type TEXT,
    file_size BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_attachments_transaction ON attachments(transaction_id);

-- Audit log table
CREATE TABLE audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    action TEXT NOT NULL CHECK (action IN ('create', 'update', 'delete')),
    entity_type TEXT NOT NULL,
    entity_id UUID NOT NULL,
    "user" TEXT NOT NULL,
    summary TEXT NOT NULL,
    details TEXT
);

CREATE INDEX idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX idx_audit_entity ON audit_log(entity_type, entity_id);

-- Categories table
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    name TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    UNIQUE(type, name)
);

CREATE INDEX idx_categories_type ON categories(type);

-- Row Level Security (enable for multi-user)
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE planned_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE sheets ENABLE ROW LEVEL SECURITY;
ALTER TABLE attachments ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Policies: Allow all authenticated users full access
CREATE POLICY "Full access" ON transactions FOR ALL USING (true);
CREATE POLICY "Full access" ON planned_templates FOR ALL USING (true);
CREATE POLICY "Full access" ON sheets FOR ALL USING (true);
CREATE POLICY "Full access" ON attachments FOR ALL USING (true);
CREATE POLICY "Full access" ON audit_log FOR ALL USING (true);
CREATE POLICY "Full access" ON categories FOR ALL USING (true);</code></pre>
        </section>

        <!-- Part 3 -->
        <section id="part3" class="guide-section">
          <h2>Part 3: Storage Bucket Setup</h2>
          <p>Fidra stores receipt attachments in Supabase Storage.</p>

          <h3>3.1 Create the Attachments Bucket</h3>
          <ol>
            <li>In your Supabase dashboard, go to <strong>Storage</strong> (left sidebar)</li>
            <li>Click <strong>New bucket</strong></li>
            <li>Enter the name: <code>attachments</code></li>
            <li>Leave "Public bucket" <strong>unchecked</strong> (private bucket)</li>
            <li>Click <strong>Create bucket</strong></li>
          </ol>

          <h3>3.2 Configure Bucket Policies</h3>
          <p>The bucket needs policies to allow uploads, downloads, and deletes.</p>
          <ol>
            <li>Click on the <strong>attachments</strong> bucket</li>
            <li>Go to the <strong>Policies</strong> tab</li>
            <li>Create three policies:</li>
          </ol>

          <h4>Policy 1: Allow Uploads (INSERT)</h4>
          <ol>
            <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
            <li>Policy name: <code>Allow uploads</code></li>
            <li>Allowed operation: <code>INSERT</code></li>
            <li>Target roles: <code>anon</code></li>
            <li>Policy definition: <code>true</code></li>
            <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
          </ol>

          <h4>Policy 2: Allow Downloads (SELECT)</h4>
          <ol>
            <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
            <li>Policy name: <code>Allow downloads</code></li>
            <li>Allowed operation: <code>SELECT</code></li>
            <li>Target roles: <code>anon</code></li>
            <li>Policy definition: <code>true</code></li>
            <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
          </ol>

          <h4>Policy 3: Allow Deletes (DELETE)</h4>
          <ol>
            <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
            <li>Policy name: <code>Allow deletes</code></li>
            <li>Allowed operation: <code>DELETE</code></li>
            <li>Target roles: <code>anon</code></li>
            <li>Policy definition: <code>true</code></li>
            <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
          </ol>

          <div class="guide-note">
            <strong>Note:</strong> When creating the DELETE policy, Supabase may require you to also select SELECT. This is fine &mdash; it will create two policies under the same name.
          </div>
        </section>

        <!-- Part 4 -->
        <section id="part4" class="guide-section">
          <h2>Part 4: Connecting Fidra to Supabase</h2>

          <h3>4.1 Gather Connection Details</h3>
          <p>You'll need three pieces of information from Supabase:</p>

          <h4>Database Connection String</h4>
          <ol>
            <li>In Supabase dashboard, click the <strong>Connect</strong> button (top navigation bar)</li>
            <li>Go to the <strong>Connection string</strong> tab</li>
            <li>Set: Type = <code>URI</code>, Source = <code>Primary Database</code>, Method = <code>Transaction Pooler</code></li>
            <li>Copy the connection string</li>
            <li>Replace <code>[YOUR-PASSWORD]</code> with your <strong>database password</strong></li>
          </ol>
          <pre><code>postgresql://postgres.xxxxxxxxxxxx:[YOUR-PASSWORD]@aws-0-xx-xxxx.pooler.supabase.com:6543/postgres</code></pre>

          <h4>Project URL and API Key</h4>
          <ol>
            <li>Go to <strong>Project Settings</strong> (gear icon, bottom of left sidebar)</li>
            <li>Click <strong>API</strong> in the settings menu</li>
            <li>Copy the <strong>Project URL</strong> and <strong>anon public</strong> key</li>
          </ol>

          <h3>4.2 Configure in Fidra</h3>

          <h4>First-Time Setup (Setup Wizard)</h4>
          <ol>
            <li>Launch Fidra</li>
            <li>On the database selection screen, click <strong>Configure Server...</strong></li>
            <li>Fill in: Server Name, Project URL, Anon Key, Database Connection String</li>
            <li>Click <strong>Test Connection</strong> to verify</li>
            <li>Click <strong>Save</strong></li>
          </ol>

          <h4>Adding a Server Later</h4>
          <ol>
            <li>Launch Fidra</li>
            <li>On the welcome screen, click <strong>Connect to Different Server...</strong></li>
            <li>Click <strong>+ Configure New Server...</strong></li>
            <li>Fill in the details, test, and save</li>
          </ol>

          <h4>From Within the App</h4>
          <ol>
            <li>Go to <strong>Settings</strong> (gear icon) &rarr; <strong>Cloud Servers...</strong></li>
            <li>Click <strong>Add Server</strong></li>
            <li>Fill in the connection details</li>
            <li>Click <strong>Test Connection</strong> then <strong>Save</strong></li>
            <li>Select the server and click <strong>Connect</strong></li>
          </ol>
        </section>

        <!-- Part 5 -->
        <section id="part5" class="guide-section">
          <h2>Part 5: How Sync Works</h2>
          <p>Once connected, Fidra uses an offline-first architecture:</p>

          <h3>Local Cache</h3>
          <p>All data is cached locally in a SQLite database. Reads always come from the local cache for instant response, even when offline.</p>

          <h3>Pushing Changes (Local to Cloud)</h3>
          <p>When you create, edit, or delete a transaction, the change is:</p>
          <ol>
            <li>Applied to the local cache immediately</li>
            <li>Queued in a persistent sync queue (survives app restarts)</li>
            <li>Pushed to PostgreSQL in the background within ~1 second</li>
          </ol>
          <p>If the network is down, changes accumulate in the queue and sync automatically when connectivity returns.</p>

          <h3>Receiving Changes (Cloud to Local)</h3>
          <p>Fidra installs PostgreSQL LISTEN/NOTIFY triggers on the synced tables. When another device makes changes, Fidra receives a notification within seconds, refreshes the affected caches, and updates the UI.</p>

          <h3>Connection Recovery</h3>
          <ul>
            <li><strong>Health checks</strong> run every 30 seconds when connected</li>
            <li>If the connection is lost, Fidra attempts reconnection with exponential backoff</li>
            <li>Once offline, recovery checks run every 5 seconds</li>
            <li>When network returns, the app reconnects automatically (no restart needed)</li>
            <li>The status bar indicator shows connection state (green/yellow/red) with a manual Reconnect button</li>
          </ul>
        </section>

        <!-- Troubleshooting -->
        <section id="troubleshooting" class="guide-section">
          <h2>Troubleshooting</h2>

          <h3>"Bucket not found" error</h3>
          <ul>
            <li>Verify the bucket is named exactly <code>attachments</code></li>
            <li>Check that storage policies are configured</li>
          </ul>

          <h3>"400 Bad Request" when uploading attachments</h3>
          <ul>
            <li>Verify the INSERT policy exists on the storage bucket</li>
            <li>Check that the anon key is correct</li>
          </ul>

          <h3>Connection timeout</h3>
          <ul>
            <li>Verify the connection string is correct</li>
            <li>Check that you're using "Transaction Pooler" method</li>
            <li>Ensure your database password is correct (no <code>[YOUR-PASSWORD]</code> placeholder)</li>
          </ul>

          <h3>"Permission denied" errors</h3>
          <ul>
            <li>Verify RLS policies are created on all tables</li>
            <li>Check that the anon key has the correct permissions</li>
          </ul>
        </section>

        <!-- Security -->
        <section id="security" class="guide-section">
          <h2>Security Considerations</h2>
          <p>The default setup uses permissive policies (<code>true</code>) which allow any request full access. For production use with multiple organisations, consider:</p>
          <ol>
            <li><strong>Row-Level Security</strong> &mdash; Add user/organisation columns and filter by authenticated user</li>
            <li><strong>Service Role Key</strong> &mdash; Use for server-side operations only, never expose in client apps</li>
            <li><strong>Custom Policies</strong> &mdash; Restrict access based on user roles or organisation membership</li>
          </ol>
          <p>For a single organisation with trusted users, the default policies are sufficient.</p>
        </section>

        <div class="guide-footer">
          <a href="index.html" class="btn ghost">&larr; Back to Fidra</a>
        </div>
      </article>
    </main>

    <footer class="footer">
      <div>&copy; 2026 Fidra</div>
      <div class="footer-links">
        <a href="https://github.com/LordPam/fidra" rel="noreferrer">GitHub</a>
        <a href="index.html#downloads">Download</a>
      </div>
    </footer>
  </body>
</html>
