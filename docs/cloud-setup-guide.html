<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cloud Setup Guide â€” Fidra</title>
    <meta name="description" content="Set up a Supabase cloud backend for Fidra to enable multi-user access and real-time sync." />
    <meta name="theme-color" content="#1a1d1b" />
    <link rel="icon" href="assets/logo.svg" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="ambient" aria-hidden="true"></div>
    <header class="nav">
      <div class="logo">
        <a href="index.html" style="display:flex;align-items:center;gap:12px;">
          <img src="assets/logo.svg" alt="Fidra" />
          <span>Fidra</span>
        </a>
      </div>
      <nav class="nav-links">
        <a href="index.html#downloads">Download</a>
        <a href="index.html#features">Features</a>
        <a href="index.html#cloud">Cloud Sync</a>
        <a href="index.html#faq">FAQ</a>
      </nav>
      <a class="nav-cta" href="index.html#downloads">Get Fidra</a>
    </header>

    <main>
      <article class="guide">
        <div class="guide-header">
          <a href="index.html" class="guide-back">&larr; Back to Fidra</a>
          <h1>Cloud Setup Guide</h1>
          <p class="guide-subtitle">Connect Fidra to a Supabase cloud backend for multi-user access and real-time sync.</p>
        </div>

        <!-- Step indicator -->
        <div class="step-indicator">
          <button class="step-dot active" data-step="0"><span>1</span></button>
          <div class="step-line"></div>
          <button class="step-dot" data-step="1"><span>2</span></button>
          <div class="step-line"></div>
          <button class="step-dot" data-step="2"><span>3</span></button>
          <div class="step-line"></div>
          <button class="step-dot" data-step="3"><span>4</span></button>
          <div class="step-line"></div>
          <button class="step-dot" data-step="4"><span>5</span></button>
        </div>
        <div class="step-labels">
          <span class="active">Create Project</span>
          <span>Database</span>
          <span>Storage</span>
          <span>Connect</span>
          <span>How It Works</span>
        </div>

        <!-- Step 1: Create Project -->
        <section class="step-panel active" data-step="0">
          <h2>Create a Supabase Project</h2>
          <p>Fidra uses <a href="https://supabase.com" class="guide-link" rel="noreferrer">Supabase</a> as its cloud backend &mdash; a hosted PostgreSQL database with file storage.</p>

          <ol>
            <li>Go to <a href="https://supabase.com" class="guide-link" rel="noreferrer">supabase.com</a> and sign in (or create a free account)</li>
            <li>Click <strong>New Project</strong></li>
            <li>Enter a project name (e.g., "Fidra Finance")</li>
            <li>Set a <strong>database password</strong> &mdash; save this, you'll need it later</li>
            <li>Select a region close to your users</li>
            <li>Click <strong>Create new project</strong></li>
          </ol>

          <div class="guide-note">
            <strong>Tip:</strong> The free tier is sufficient for most small teams. You get 500MB database storage and 1GB file storage.
          </div>

          <p>Wait for the project to be provisioned (usually 1&ndash;2 minutes), then continue to the next step.</p>

          <div class="step-nav">
            <div></div>
            <button class="btn primary step-next">Next: Database Schema &rarr;</button>
          </div>
        </section>

        <!-- Step 2: Database Schema -->
        <section class="step-panel" data-step="1">
          <h2>Set Up the Database</h2>
          <p>Fidra needs six tables in your Supabase database. Open the <strong>SQL Editor</strong> in your Supabase dashboard, create a new query, paste the SQL below, and click <strong>Run</strong>.</p>

          <details class="sql-collapsible" open>
            <summary>
              <span>Full SQL schema</span>
              <button class="copy-btn" data-target="schema-sql">Copy</button>
            </summary>
            <div class="code-block">
              <pre id="schema-sql"><code>-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Transactions table
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    date DATE NOT NULL,
    description TEXT NOT NULL,
    amount NUMERIC(15, 2) NOT NULL CHECK (amount > 0),
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    status TEXT NOT NULL CHECK (status IN ('--', 'pending', 'approved', 'rejected', 'planned')),
    sheet TEXT NOT NULL,
    category TEXT,
    party TEXT,
    notes TEXT,
    reference TEXT,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    modified_at TIMESTAMPTZ,
    modified_by TEXT
);

CREATE INDEX idx_transactions_date ON transactions(date DESC);
CREATE INDEX idx_transactions_sheet ON transactions(sheet);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_status ON transactions(status);

-- Planned templates table
CREATE TABLE planned_templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    start_date DATE NOT NULL,
    description TEXT NOT NULL,
    amount NUMERIC(15, 2) NOT NULL CHECK (amount > 0),
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    frequency TEXT NOT NULL CHECK (frequency IN ('once', 'weekly', 'biweekly', 'monthly', 'quarterly', 'yearly')),
    target_sheet TEXT NOT NULL,
    category TEXT,
    party TEXT,
    end_date DATE,
    occurrence_count INTEGER,
    skipped_dates JSONB DEFAULT '[]'::jsonb,
    fulfilled_dates JSONB DEFAULT '[]'::jsonb,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_planned_start ON planned_templates(start_date);
CREATE INDEX idx_planned_target ON planned_templates(target_sheet);

-- Sheets table
CREATE TABLE sheets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT UNIQUE NOT NULL,
    is_virtual BOOLEAN DEFAULT FALSE,
    is_planned BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_sheets_name ON sheets(name);

-- Attachments table (metadata only - files in Supabase Storage)
CREATE TABLE attachments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    transaction_id UUID NOT NULL REFERENCES transactions(id) ON DELETE CASCADE,
    filename TEXT NOT NULL,
    stored_name TEXT NOT NULL,
    mime_type TEXT,
    file_size BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_attachments_transaction ON attachments(transaction_id);

-- Audit log table
CREATE TABLE audit_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    action TEXT NOT NULL CHECK (action IN ('create', 'update', 'delete')),
    entity_type TEXT NOT NULL,
    entity_id UUID NOT NULL,
    "user" TEXT NOT NULL,
    summary TEXT NOT NULL,
    details TEXT
);

CREATE INDEX idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX idx_audit_entity ON audit_log(entity_type, entity_id);

-- Categories table
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    name TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    UNIQUE(type, name)
);

CREATE INDEX idx_categories_type ON categories(type);

-- Row Level Security (enable for multi-user)
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE planned_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE sheets ENABLE ROW LEVEL SECURITY;
ALTER TABLE attachments ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Policies: Allow all authenticated users full access
CREATE POLICY "Full access" ON transactions FOR ALL USING (true);
CREATE POLICY "Full access" ON planned_templates FOR ALL USING (true);
CREATE POLICY "Full access" ON sheets FOR ALL USING (true);
CREATE POLICY "Full access" ON attachments FOR ALL USING (true);
CREATE POLICY "Full access" ON audit_log FOR ALL USING (true);
CREATE POLICY "Full access" ON categories FOR ALL USING (true);</code></pre>
            </div>
          </details>

          <p>The query creates all tables, indexes, and row-level security policies. You should see "Success" in the Supabase SQL editor.</p>

          <div class="step-nav">
            <button class="btn ghost step-back">&larr; Back</button>
            <button class="btn primary step-next">Next: Storage Bucket &rarr;</button>
          </div>
        </section>

        <!-- Step 3: Storage Bucket -->
        <section class="step-panel" data-step="2">
          <h2>Set Up File Storage</h2>
          <p>Fidra stores receipt attachments in Supabase Storage. You need to create a bucket and set access policies.</p>

          <h3>Create the bucket</h3>
          <ol>
            <li>In your Supabase dashboard, go to <strong>Storage</strong> (left sidebar)</li>
            <li>Click <strong>New bucket</strong></li>
            <li>Name: <code>attachments</code></li>
            <li>Leave "Public bucket" <strong>unchecked</strong></li>
            <li>Click <strong>Create bucket</strong></li>
          </ol>

          <h3>Add access policies</h3>
          <p>Click on the <strong>attachments</strong> bucket, go to the <strong>Policies</strong> tab, and create these three policies:</p>

          <details class="policy-details">
            <summary>Policy 1: Allow Uploads (INSERT)</summary>
            <ol>
              <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
              <li>Policy name: <code>Allow uploads</code></li>
              <li>Allowed operation: <code>INSERT</code></li>
              <li>Target roles: <code>anon</code></li>
              <li>Policy definition: <code>true</code></li>
              <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
            </ol>
          </details>

          <details class="policy-details">
            <summary>Policy 2: Allow Downloads (SELECT)</summary>
            <ol>
              <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
              <li>Policy name: <code>Allow downloads</code></li>
              <li>Allowed operation: <code>SELECT</code></li>
              <li>Target roles: <code>anon</code></li>
              <li>Policy definition: <code>true</code></li>
              <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
            </ol>
          </details>

          <details class="policy-details">
            <summary>Policy 3: Allow Deletes (DELETE)</summary>
            <ol>
              <li>Click <strong>New policy</strong> &rarr; <strong>For full customization</strong></li>
              <li>Policy name: <code>Allow deletes</code></li>
              <li>Allowed operation: <code>DELETE</code></li>
              <li>Target roles: <code>anon</code></li>
              <li>Policy definition: <code>true</code></li>
              <li>Click <strong>Review</strong> then <strong>Save policy</strong></li>
            </ol>
          </details>

          <div class="guide-note">
            <strong>Note:</strong> When creating the DELETE policy, Supabase may require you to also select SELECT. This is fine.
          </div>

          <div class="step-nav">
            <button class="btn ghost step-back">&larr; Back</button>
            <button class="btn primary step-next">Next: Connect Fidra &rarr;</button>
          </div>
        </section>

        <!-- Step 4: Connect Fidra -->
        <section class="step-panel" data-step="3">
          <h2>Connect Fidra to Supabase</h2>
          <p>Gather three pieces of information from your Supabase dashboard, then enter them in Fidra.</p>

          <h3>1. Get your connection details</h3>

          <div class="detail-card">
            <h4>Database Connection String</h4>
            <p>Click <strong>Connect</strong> (top bar) &rarr; <strong>Connection string</strong> tab &rarr; set Type = <code>URI</code>, Source = <code>Primary Database</code>, Method = <code>Transaction Pooler</code>. Copy the string and replace <code>[YOUR-PASSWORD]</code> with your database password.</p>
            <div class="code-block">
              <pre id="conn-string"><code>postgresql://postgres.xxxx:[YOUR-PASSWORD]@aws-0-xx-xxxx.pooler.supabase.com:6543/postgres</code></pre>
              <button class="copy-btn" data-target="conn-string">Copy</button>
            </div>
          </div>

          <div class="detail-card">
            <h4>Project URL &amp; Anon Key</h4>
            <p>Go to <strong>Project Settings</strong> (gear icon) &rarr; <strong>API</strong>. Copy the <strong>Project URL</strong> and <strong>anon public</strong> key.</p>
          </div>

          <h3>2. Enter them in Fidra</h3>
          <p>This is what the connection form looks like in the app:</p>

          <div class="form-mockup">
            <div class="form-mockup-header">Add Cloud Server</div>
            <div class="form-mockup-group">
              <label>Name</label>
              <div class="form-mockup-input">Sub Aqua Club</div>
            </div>
            <div class="form-mockup-group">
              <label>Connection</label>
              <div class="form-mockup-input password">postgresql://postgres.abc:&bull;&bull;&bull;&bull;&bull;&bull;@aws-0-eu.pooler.supabase.com:6543/postgres</div>
            </div>
            <div class="form-mockup-group">
              <label>URL</label>
              <div class="form-mockup-input">https://abcdefghij.supabase.co</div>
            </div>
            <div class="form-mockup-group">
              <label>Anon Key</label>
              <div class="form-mockup-input password">eyJhbGciOiJIUzI1NiIsInR5cCI6&bull;&bull;&bull;&bull;&bull;&bull;</div>
            </div>
            <div class="form-mockup-group">
              <label>Bucket</label>
              <div class="form-mockup-input">attachments</div>
            </div>
            <div class="form-mockup-actions">
              <span class="form-mockup-btn test">Test Connection</span>
              <span class="form-mockup-btn save">Save</span>
            </div>
          </div>

          <p>You can access this form from the <strong>Setup Wizard</strong> (first launch), the <strong>Welcome screen</strong>, or from <strong>Settings &rarr; Cloud Servers</strong>.</p>

          <div class="step-nav">
            <button class="btn ghost step-back">&larr; Back</button>
            <button class="btn primary step-next">Next: How It Works &rarr;</button>
          </div>
        </section>

        <!-- Step 5: How It Works -->
        <section class="step-panel" data-step="4">
          <h2>How Sync Works</h2>
          <p>Once connected, Fidra uses an offline-first architecture. Everything stays fast regardless of network conditions.</p>

          <div class="sync-flow">
            <div class="sync-card">
              <div class="sync-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              </div>
              <h4>Local cache</h4>
              <p>All data cached in a local SQLite database. Reads are always instant &mdash; even offline.</p>
            </div>
            <div class="sync-card">
              <div class="sync-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>
              </div>
              <h4>Background sync</h4>
              <p>Changes queue locally and push to PostgreSQL within ~1 second. If offline, they sync when connectivity returns.</p>
            </div>
            <div class="sync-card">
              <div class="sync-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              </div>
              <h4>Real-time updates</h4>
              <p>Changes from other devices arrive via PostgreSQL LISTEN/NOTIFY. The UI updates automatically.</p>
            </div>
          </div>

          <h3>Connection recovery</h3>
          <ul>
            <li>Health checks run every 30 seconds</li>
            <li>Lost connections retry with exponential backoff</li>
            <li>The status bar shows connection state (green/yellow/red) with a manual reconnect button</li>
            <li>No restart needed &mdash; Fidra reconnects automatically</li>
          </ul>

          <div class="step-nav">
            <button class="btn ghost step-back">&larr; Back</button>
            <div></div>
          </div>
        </section>

        <!-- Troubleshooting & Security (outside wizard) -->
        <div class="guide-extras">
          <details class="guide-extra">
            <summary>Troubleshooting</summary>
            <div class="extra-content">
              <h4>"Bucket not found" error</h4>
              <p>Verify the bucket is named exactly <code>attachments</code> and that storage policies are configured.</p>
              <h4>"400 Bad Request" when uploading</h4>
              <p>Verify the INSERT policy exists on the storage bucket and the anon key is correct.</p>
              <h4>Connection timeout</h4>
              <p>Check the connection string, ensure you're using "Transaction Pooler" method, and verify the password (no <code>[YOUR-PASSWORD]</code> placeholder).</p>
              <h4>"Permission denied" errors</h4>
              <p>Verify RLS policies are created on all tables and the anon key has correct permissions.</p>
            </div>
          </details>

          <details class="guide-extra">
            <summary>Security Considerations</summary>
            <div class="extra-content">
              <p>The default setup uses permissive policies (<code>true</code>) which allow any request full access. For production use with multiple organisations, consider:</p>
              <ol>
                <li><strong>Row-Level Security</strong> &mdash; add user/organisation columns and filter by authenticated user</li>
                <li><strong>Service Role Key</strong> &mdash; use for server-side operations only, never expose in client apps</li>
                <li><strong>Custom Policies</strong> &mdash; restrict access based on user roles or organisation membership</li>
              </ol>
              <p>For a single organisation with trusted users, the default policies are sufficient.</p>
            </div>
          </details>
        </div>

        <div class="guide-footer">
          <a href="index.html" class="btn ghost">&larr; Back to Fidra</a>
        </div>
      </article>
    </main>

    <footer class="footer">
      <div>&copy; 2026 Fidra</div>
      <div class="footer-links">
        <a href="https://github.com/LordPam/fidra" rel="noreferrer">GitHub</a>
        <a href="index.html#downloads">Download</a>
      </div>
    </footer>

    <script>
    (function () {
      const panels = document.querySelectorAll('.step-panel');
      const dots = document.querySelectorAll('.step-dot');
      const labels = document.querySelectorAll('.step-labels span');
      let current = 0;

      function goTo(step) {
        if (step < 0 || step >= panels.length) return;
        panels[current].classList.remove('active');
        dots[current].classList.remove('active');
        labels[current].classList.remove('active');
        // Mark completed steps
        for (let i = 0; i < step; i++) {
          dots[i].classList.add('done');
        }
        for (let i = step; i < dots.length; i++) {
          dots[i].classList.remove('done');
        }
        current = step;
        panels[current].classList.add('active');
        dots[current].classList.add('active');
        labels[current].classList.remove('done');
        labels[current].classList.add('active');
        // Scroll to top of guide
        document.querySelector('.step-indicator').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      dots.forEach(function (dot) {
        dot.addEventListener('click', function () {
          goTo(parseInt(this.dataset.step));
        });
      });

      document.querySelectorAll('.step-next').forEach(function (btn) {
        btn.addEventListener('click', function () { goTo(current + 1); });
      });

      document.querySelectorAll('.step-back').forEach(function (btn) {
        btn.addEventListener('click', function () { goTo(current - 1); });
      });

      // Copy buttons
      document.querySelectorAll('.copy-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          var target = document.getElementById(this.dataset.target);
          var text = target ? target.textContent : '';
          navigator.clipboard.writeText(text).then(function () {
            btn.textContent = 'Copied!';
            setTimeout(function () { btn.textContent = 'Copy'; }, 2000);
          });
        });
      });
    })();
    </script>
  </body>
</html>
